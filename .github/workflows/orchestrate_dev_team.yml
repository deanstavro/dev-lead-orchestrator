name: AI Agent Orchestrator

on:
  # Receive events from other repos via repository_dispatch
  repository_dispatch:
    types: 
      - agent_start
      - agent_stop
      - human_response
      - qa_review
      - post_merge_monitor
  
  # Scheduled events (runs in this repo)
  schedule:
    # Every Friday at 9 AM UTC
    - cron: '0 9 * * 5'
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - start_processing
          - refactor_scan
          - test_connection
      issue_number:
        description: 'Issue number (optional)'
        required: false
        type: number
      repository:
        description: 'Repository (e.g., Cherry-Application/cherry-frontend)'
        required: false
        type: string

jobs:
  # ============================================
  # JOB 1: Route to Vercel Agents
  # ============================================
  route-to-agents:
    name: Route to Agents
    runs-on: ubuntu-latest
    if: github.event_name == 'repository_dispatch'
    
    steps:
      - name: Extract event data
        id: extract
        run: |
          echo "Event type: ${{ github.event.action }}"
          echo "Payload: ${{ toJSON(github.event.client_payload) }}"
      
      - name: Forward to Vercel
        env:
          VERCEL_WEBHOOK_URL: ${{ secrets.VERCEL_WEBHOOK_URL }}
        run: |
          # Map repository_dispatch type to action
          ACTION="${{ github.event.action }}"
          
          # Convert action names (agent_start -> start_processing)
          case "$ACTION" in
            "agent_start")
              ACTION="start_processing"
              ;;
            "agent_stop")
              ACTION="stop_processing"
              ;;
          esac
          
          # Build payload with action and client_payload data
          PAYLOAD=$(jq -n \
            --arg action "$ACTION" \
            --argjson client_payload '${{ toJSON(github.event.client_payload) }}' \
            '{action: $action} + $client_payload')
          
          echo "Sending to Vercel: $PAYLOAD"
          
          curl -X POST "$VERCEL_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

  # ============================================
  # JOB 2: Weekly Refactoring Scan
  # ============================================
  weekly-refactor-scan:
    name: Weekly Refactoring Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    strategy:
      matrix:
        repo: 
          - Cherry-Application/cherry-frontend
          # Add more repos as needed:
          # - Cherry-Application/cherry-backend
          # - Cherry-Application/cherry-mobile
    
    steps:
      - name: Trigger refactoring scan for ${{ matrix.repo }}
        env:
          VERCEL_WEBHOOK_URL: ${{ secrets.VERCEL_WEBHOOK_URL }}
        run: |
          curl -X POST "$VERCEL_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "action": "refactor_scan",
              "repository": "${{ matrix.repo }}",
              "branch": "main"
            }'

  # ============================================
  # JOB 3: Manual Trigger Handler
  # ============================================
  manual-trigger:
    name: Manual Trigger
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Execute manual action
        env:
          VERCEL_WEBHOOK_URL: ${{ secrets.VERCEL_WEBHOOK_URL }}
        run: |
          PAYLOAD='{
            "action": "${{ github.event.inputs.action }}"'
          
          if [ -n "${{ github.event.inputs.issue_number }}" ]; then
            PAYLOAD="$PAYLOAD, \"issue_number\": ${{ github.event.inputs.issue_number }}"
          fi
          
          if [ -n "${{ github.event.inputs.repository }}" ]; then
            PAYLOAD="$PAYLOAD, \"repository\": \"${{ github.event.inputs.repository }}\""
          fi
          
          PAYLOAD="$PAYLOAD }"
          
          echo "Sending: $PAYLOAD"
          
          curl -X POST "$VERCEL_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"