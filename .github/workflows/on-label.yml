# This workflow should be added to cherry-frontend repo
# It triggers the agent when labels are added/removed

name: Agent Label Handler

on:
  issues:
    types: [labeled, unlabeled]
  issue_comment:
    types: [created]

jobs:
  handle-agent-start:
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'agent:start'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger agent start
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_PAT }}
          repository: Cherry-Application/cherry-automation
          event-type: agent_start
          client-payload: |
            {
              "action": "start",
              "source_repo": "${{ github.repository }}",
              "issue_number": ${{ github.event.issue.number }},
              "issue_title": ${{ toJson(github.event.issue.title) }},
              "issue_body": ${{ toJson(github.event.issue.body) }},
              "sender": "${{ github.event.sender.login }}"
            }

  handle-agent-stop:
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'agent:stop'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger agent stop
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_PAT }}
          repository: Cherry-Application/cherry-automation
          event-type: agent_stop
          client-payload: |
            {
              "action": "stop",
              "source_repo": "${{ github.repository }}",
              "issue_number": ${{ github.event.issue.number }},
              "sender": "${{ github.event.sender.login }}"
            }

  handle-agent-implement:
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'agent:implement'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger agent implement
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_PAT }}
          repository: Cherry-Application/cherry-automation
          event-type: agent_implement
          client-payload: |
            {
              "action": "implement",
              "source_repo": "${{ github.repository }}",
              "issue_number": ${{ github.event.issue.number }},
              "issue_title": ${{ toJson(github.event.issue.title) }},
              "sender": "${{ github.event.sender.login }}"
            }

  handle-human-response:
    if: |
      github.event_name == 'issue_comment' && 
      github.event.action == 'created' &&
      github.event.comment.user.type != 'Bot' &&
      !contains(github.event.comment.body, 'Team Lead') &&
      !contains(github.event.comment.body, 'Delegating to') &&
      !contains(github.event.comment.body, 'agent...') &&
      !contains(github.event.comment.body, 'result:') &&
      !startsWith(github.event.comment.body, 'ðŸ¤–') &&
      !startsWith(github.event.comment.body, 'ðŸ¤”') &&
      !startsWith(github.event.comment.body, 'ðŸ“‹') &&
      !startsWith(github.event.comment.body, 'ðŸ—ï¸') &&
      !startsWith(github.event.comment.body, 'ðŸ“') &&
      !startsWith(github.event.comment.body, 'âœ…') &&
      !startsWith(github.event.comment.body, 'ðŸŽ‰') &&
      !startsWith(github.event.comment.body, 'ðŸ›‘') &&
      !startsWith(github.event.comment.body, 'ðŸ”') &&
      !startsWith(github.event.comment.body, 'ðŸ”§') &&
      !startsWith(github.event.comment.body, 'âš ï¸') &&
      !startsWith(github.event.comment.body, 'âŒ') &&
      !startsWith(github.event.comment.body, 'â“') &&
      !startsWith(github.event.comment.body, 'ðŸ§ª') &&
      !startsWith(github.event.comment.body, 'ðŸš€') &&
      !startsWith(github.event.comment.body, 'â­ï¸') &&
      !startsWith(github.event.comment.body, 'ðŸš«')
    runs-on: ubuntu-latest
    steps:
      - name: Check for agent label
        id: check-label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            const hasAgentLabel = labels.includes('agent:start') || labels.includes('agent:active');
            return hasAgentLabel;
          result-encoding: string

      - name: Trigger human response
        if: steps.check-label.outputs.result == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_PAT }}
          repository: Cherry-Application/cherry-automation
          event-type: human_response
          client-payload: |
            {
              "action": "human_response",
              "source_repo": "${{ github.repository }}",
              "issue_number": ${{ github.event.issue.number }},
              "comment_id": ${{ github.event.comment.id }},
              "comment_body": ${{ toJson(github.event.comment.body) }},
              "comment_author": "${{ github.event.comment.user.login }}"
            }

